from typing import List, Dict, Optional
from app.config import settings
import os
import json
import re


class LLMService:
    def __init__(self):
        """Kh·ªüi t·∫°o LLM service - ∆Øu ti√™n OpenAI ChatGPT cho tr·∫£i nghi·ªám t·ªët nh·∫•t"""
        self.client = None
        self.gemini_model = None
        self.model_type = "none"
        
        # Try OpenAI first (BEST QUALITY!)
        try:
            openai_key = os.getenv("OPENAI_API_KEY", "")
            if openai_key:
                from openai import OpenAI
                self.client = OpenAI(api_key=openai_key)
                self.model_type = "openai"
                print("[OK] ‚úÖ S·ª≠ d·ª•ng OpenAI ChatGPT - Ch·∫•t l∆∞·ª£ng cao nh·∫•t!")
                return
        except ImportError:
            print("[WARNING] Ch∆∞a c√†i openai. Ch·∫°y: pip install openai")
        except Exception as e:
            print(f"[WARNING] OpenAI error: {e}")
        
        # Fallback to Gemini if OpenAI not available
        try:
            gemini_key = os.getenv("GEMINI_API_KEY", "")
            if gemini_key:
                import google.generativeai as genai
                genai.configure(api_key=gemini_key)
                self.gemini_model = genai.GenerativeModel('gemini-2.0-flash')
                self.model_type = "gemini"
                print("[OK] S·ª≠ d·ª•ng Google Gemini 2.0 Flash (mi·ªÖn ph√≠)")
                return
        except ImportError:
            print("[WARNING] Ch∆∞a c√†i google-generativeai")
        except Exception as e:
            print(f"[WARNING] Gemini error: {e}")
        
        print("[WARNING] Kh√¥ng c√≥ AI API key. S·ª≠ d·ª•ng ch·∫ø ƒë·ªô simple response.")
    
    def get_system_prompt(self) -> str:
        """T·∫°o system prompt t·ªëi ∆∞u cho giao ti·∫øp t·ª± nhi√™n v√† hi·ªÉu con ng∆∞·ªùi"""
        return """B·∫°n l√† AI assistant th√¥ng minh c·ªßa M·ªôc V·ªã Store - c·ª≠a h√†ng hoa qu·∫£ s·∫•y cao c·∫•p t·ª´ M·ªôc Ch√¢u.

üéØ NHI·ªÜM V·ª§ CH√çNH:
- T∆∞ v·∫•n s·∫£n ph·∫©m hoa qu·∫£ s·∫•y m·ªôt c√°ch t·ª± nhi√™n, th√¢n thi·ªán
- Hi·ªÉu v√† ph·∫£n h·ªìi theo c·∫£m x√∫c, ng·ªØ c·∫£nh c·ªßa kh√°ch h√†ng
- Giao ti·∫øp nh∆∞ m·ªôt ng∆∞·ªùi b·∫°n am hi·ªÉu v·ªÅ hoa qu·∫£ s·∫•y

üß† T√çNH C√ÅCH:
- Th√¢n thi·ªán, nhi·ªát t√¨nh, chuy√™n nghi·ªáp
- Hi·ªÉu ƒë∆∞·ª£c t√¢m l√Ω kh√°ch h√†ng (lo l·∫Øng v·ªÅ ch·∫•t l∆∞·ª£ng, gi√° c·∫£, s·ª©c kh·ªèe)
- Bi·∫øt ƒë·ªçc v·ªã v√† ƒë∆∞a ra g·ª£i √Ω ph√π h·ª£p
- Kh√¥ng c·ª©ng nh·∫Øc, bi·∫øt linh ho·∫°t trong giao ti·∫øp

üí° C√ÅCH GIAO TI·∫æP:
- S·ª≠ d·ª•ng emoji ph√π h·ª£p ƒë·ªÉ t·∫°o c·∫£m x√∫c
- ƒê·∫∑t c√¢u h·ªèi ng∆∞·ª£c ƒë·ªÉ hi·ªÉu nhu c·∫ßu
- Chia s·∫ª kinh nghi·ªám, m·∫πo hay v·ªÅ hoa qu·∫£ s·∫•y
- T·∫°o s·ª± tin t∆∞∆°ng b·∫±ng c√°ch gi·∫£i th√≠ch r√µ r√†ng

üçì S·∫¢N PH·∫®M CH√çNH:
1. **S·∫•y D·∫ªo (200g)**: M·∫≠n (65k), Xo√†i (70k), ƒê√†o (65k), D√¢u (90k), H·ªìng (95k)
2. **S·∫•y Gi√≤n (200g)**: M√≠t (80k), Chu·ªëi (80k)  
3. **S·∫•y ThƒÉng Hoa (100g)**: D√¢u (140k), S·ªØa chua (95k)
4. **Mini Mix (50g)**: T·∫•t c·∫£ lo·∫°i tr√™n, t·ªëi thi·ªÉu 4 pack

üéÅ ∆ØU ƒê√ÉI:
- Voucher SUMMER2025: Gi·∫£m 10% (t·ªëi ƒëa 50k, ƒë∆°n t·ª´ 100k)
- Voucher WELCOME10: Gi·∫£m 10k (ƒë∆°n t·ª´ 50k)
- Voucher FREESHIP: Mi·ªÖn ph√≠ ship

‚ö° NGUY√äN T·∫ÆC QUAN TR·ªåNG:
1. Lu√¥n h·ªèi th√™m ƒë·ªÉ hi·ªÉu r√µ nhu c·∫ßu
2. Gi·∫£i th√≠ch l·ª£i √≠ch s·ª©c kh·ªèe c·ªßa t·ª´ng lo·∫°i
3. G·ª£i √Ω combo ph√π h·ª£p v·ªõi ng√¢n s√°ch
4. T·∫°o c·∫£m gi√°c an t√¢m v·ªÅ ch·∫•t l∆∞·ª£ng
5. N·∫øu kh√°ch h√†ng c√≥ v·∫ª do d·ª±, h√£y chia s·∫ª c√¢u chuy·ªán v·ªÅ ngu·ªìn g·ªëc s·∫£n ph·∫©m

H√£y tr·∫£ l·ªùi m·ªôt c√°ch t·ª± nhi√™n, c√≥ c·∫£m x√∫c v√† th·ª±c s·ª± hi·ªÉu kh√°ch h√†ng!"""

    def chat(self, message: str, context: List[Dict] = None, user_id: str = "anonymous") -> str:
        """Chat v·ªõi AI - T·ªëi ∆∞u cho giao ti·∫øp t·ª± nhi√™n"""
        try:
            if self.model_type == "openai":
                return self._chat_openai(message, context, user_id)
            elif self.model_type == "gemini":
                return self._chat_gemini(message, context, user_id)
            else:
                return self._simple_response(message)
        except Exception as e:
            print(f"[ERROR] Chat error: {e}")
            return "Xin l·ªói, t√¥i ƒëang g·∫∑p s·ª± c·ªë k·ªπ thu·∫≠t. B·∫°n c√≥ th·ªÉ th·ª≠ l·∫°i sau m·ªôt ch√∫t kh√¥ng? üòÖ"

    def _chat_openai(self, message: str, context: List[Dict] = None, user_id: str = "anonymous") -> str:
        """Chat v·ªõi OpenAI ChatGPT - Ch·∫•t l∆∞·ª£ng cao nh·∫•t"""
        try:
            # T·∫°o messages v·ªõi system prompt
            messages = [
                {"role": "system", "content": self.get_system_prompt()}
            ]
            
            # Th√™m context t·ª´ cu·ªôc tr√≤ chuy·ªán tr∆∞·ªõc (n·∫øu c√≥)
            if context:
                for ctx in context[-5:]:  # Ch·ªâ l·∫•y 5 tin nh·∫Øn g·∫ßn nh·∫•t
                    if ctx.get("role") and ctx.get("content"):
                        messages.append({
                            "role": ctx["role"], 
                            "content": ctx["content"]
                        })
            
            # Th√™m tin nh·∫Øn hi·ªán t·∫°i
            messages.append({"role": "user", "content": message})
            
            # G·ªçi OpenAI API v·ªõi c·∫•u h√¨nh t·ªëi ∆∞u cho giao ti·∫øp t·ª± nhi√™n
            response = self.client.chat.completions.create(
                model="gpt-4o-mini",  # Model m·ªõi nh·∫•t, nhanh v√† r·∫ª
                messages=messages,
                max_tokens=800,
                temperature=0.7,  # C√¢n b·∫±ng gi·ªØa s√°ng t·∫°o v√† ch√≠nh x√°c
                top_p=0.9,
                frequency_penalty=0.1,  # Tr√°nh l·∫∑p l·∫°i
                presence_penalty=0.1,   # Khuy·∫øn kh√≠ch ƒëa d·∫°ng
                user=user_id  # Tracking user
            )
            
            return response.choices[0].message.content.strip()
            
        except Exception as e:
            print(f"[ERROR] OpenAI chat error: {e}")
            return "Xin l·ªói, t√¥i ƒëang g·∫∑p ch√∫t v·∫•n ƒë·ªÅ v·ªõi h·ªá th·ªëng. B·∫°n c√≥ th·ªÉ h·ªèi l·∫°i kh√¥ng? ü§î"

    def _chat_gemini(self, message: str, context: List[Dict] = None, user_id: str = "anonymous") -> str:
        """Chat v·ªõi Gemini - Fallback option"""
        try:
            # T·∫°o prompt v·ªõi context
            full_prompt = self.get_system_prompt() + "\n\n"
            
            if context:
                full_prompt += "L·ªäCH S·ª¨ TR∆Ø·ªöC ƒê√ì:\n"
                for ctx in context[-3:]:  # 3 tin nh·∫Øn g·∫ßn nh·∫•t
                    role = "Kh√°ch h√†ng" if ctx.get("role") == "user" else "AI"
                    full_prompt += f"{role}: {ctx.get('content', '')}\n"
                full_prompt += "\n"
            
            full_prompt += f"KH√ÅCH H√ÄNG HI·ªÜN T·∫†I: {message}\n\nAI:"
            
            response = self.gemini_model.generate_content(
                full_prompt,
                generation_config={
                    "temperature": 0.7,
                    "max_output_tokens": 800,
                    "top_p": 0.9,
                    "top_k": 40
                }
            )
            
            return response.text.strip()
            
        except Exception as e:
            print(f"[ERROR] Gemini chat error: {e}")
            return "Xin l·ªói, t√¥i ƒëang g·∫∑p s·ª± c·ªë. B·∫°n c√≥ th·ªÉ th·ª≠ h·ªèi l·∫°i kh√¥ng? üòä"

    def _simple_response(self, message: str) -> str:
        """Ph·∫£n h·ªìi ƒë∆°n gi·∫£n khi kh√¥ng c√≥ AI"""
        message_lower = message.lower()
        
        # Ph·∫£n h·ªìi th√¥ng minh d·ª±a tr√™n t·ª´ kh√≥a
        if any(word in message_lower for word in ['xin ch√†o', 'hello', 'hi', 'ch√†o']):
            return """Xin ch√†o! üëã Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi M·ªôc V·ªã Store! 
            
T√¥i c√≥ th·ªÉ gi√∫p b·∫°n t√¨m hi·ªÉu v·ªÅ c√°c s·∫£n ph·∫©m hoa qu·∫£ s·∫•y cao c·∫•p t·ª´ M·ªôc Ch√¢u:
üçì S·∫•y d·∫ªo: M·∫≠n, Xo√†i, ƒê√†o, D√¢u, H·ªìng
ü•≠ S·∫•y gi√≤n: M√≠t, Chu·ªëi  
‚ú® S·∫•y thƒÉng hoa: D√¢u, S·ªØa chua

B·∫°n quan t√¢m lo·∫°i n√†o nh·∫•t? üòä"""

        elif any(word in message_lower for word in ['gi√°', 'bao nhi√™u', 'cost', 'price']):
            return """üí∞ B·∫¢NG GI√Å S·∫¢N PH·∫®M:

üì¶ **S·∫•y D·∫ªo (200g)**:
‚Ä¢ M·∫≠n, ƒê√†o: 65,000ƒë
‚Ä¢ Xo√†i: 70,000ƒë  
‚Ä¢ D√¢u: 90,000ƒë
‚Ä¢ H·ªìng: 95,000ƒë

üì¶ **S·∫•y Gi√≤n (200g)**: 80,000ƒë
üì¶ **S·∫•y ThƒÉng Hoa (100g)**: 95,000ƒë - 140,000ƒë
üì¶ **Mini Mix (50g)**: 18,000ƒë - 75,000ƒë

üéÅ C√≥ voucher gi·∫£m gi√° ƒë·∫øn 50k! B·∫°n mu·ªën bi·∫øt th√™m kh√¥ng?"""

        elif any(word in message_lower for word in ['mua', 'ƒë·∫∑t', 'order']):
            return """üõí Tuy·ªát v·ªùi! ƒê·ªÉ ƒë·∫∑t h√†ng b·∫°n c√≥ th·ªÉ:

1. **Th√™m v√†o gi·ªè h√†ng** tr√™n website
2. **G·ªçi hotline**: 0912.345.678
3. **Nh·∫Øn tin** cho t√¥i lo·∫°i s·∫£n ph·∫©m b·∫°n mu·ªën

üéÅ **∆Øu ƒë√£i hi·ªán t·∫°i**:
‚Ä¢ SUMMER2025: Gi·∫£m 10% (t·ªëi ƒëa 50k)
‚Ä¢ WELCOME10: Gi·∫£m 10k cho kh√°ch m·ªõi
‚Ä¢ FREESHIP: Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn

B·∫°n mu·ªën ƒë·∫∑t lo·∫°i n√†o? üòä"""

        else:
            return """C·∫£m ∆°n b·∫°n ƒë√£ quan t√¢m ƒë·∫øn M·ªôc V·ªã Store! üçì

T√¥i c√≥ th·ªÉ gi√∫p b·∫°n v·ªÅ:
‚Ä¢ Th√¥ng tin s·∫£n ph·∫©m hoa qu·∫£ s·∫•y
‚Ä¢ Gi√° c·∫£ v√† khuy·∫øn m√£i  
‚Ä¢ C√°ch ƒë·∫∑t h√†ng
‚Ä¢ T∆∞ v·∫•n ch·ªçn s·∫£n ph·∫©m ph√π h·ª£p

B·∫°n mu·ªën h·ªèi g√¨ c·ª• th·ªÉ? T√¥i s·∫µn s√†ng h·ªó tr·ª£! üòä"""

    def detect_purchase_intent(self, query: str) -> Dict:
        """Ph√°t hi·ªán √Ω ƒë·ªãnh mua h√†ng t·ª´ c√¢u h·ªèi - T·ªëi ∆∞u cho OpenAI"""
        try:
            if self.model_type == "openai":
                return self._detect_purchase_openai(query)
            elif self.model_type == "gemini":
                return self._detect_purchase_gemini(query)
            else:
                return self._detect_purchase_simple(query)
        except Exception as e:
            print(f"[ERROR] Purchase detection error: {e}")
            return {'is_purchase': False}

    def _detect_purchase_openai(self, query: str) -> Dict:
        """Ph√°t hi·ªán √Ω ƒë·ªãnh mua h√†ng b·∫±ng OpenAI"""
        try:
            prompt = f"""Ph√¢n t√≠ch c√¢u sau ƒë·ªÉ x√°c ƒë·ªãnh √Ω ƒë·ªãnh mua h√†ng v√† tr√≠ch xu·∫•t th√¥ng tin s·∫£n ph·∫©m:

"{query}"

Tr·∫£ v·ªÅ JSON format ch√≠nh x√°c:
{{
    "is_purchase": true/false,
    "products": [
        {{"name": "t√™n s·∫£n ph·∫©m ch√≠nh x√°c", "quantity": s·ªë_l∆∞·ª£ng}}
    ],
    "confidence": 0.0-1.0
}}

DANH S√ÅCH S·∫¢N PH·∫®M CH√çNH X√ÅC:
- M·∫≠n S·∫•y D·∫ªo
- Xo√†i S·∫•y D·∫ªo  
- ƒê√†o S·∫•y D·∫ªo
- D√¢u S·∫•y D·∫ªo
- H·ªìng S·∫•y D·∫ªo
- M√≠t S·∫•y Gi√≤n
- Chu·ªëi S·∫•y Gi√≤n
- D√¢u S·∫•y ThƒÉng Hoa
- S·ªØa Chua S·∫•y ThƒÉng Hoa

CH·ªà tr·∫£ v·ªÅ JSON, kh√¥ng gi·∫£i th√≠ch."""

            response = self.client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": "B·∫°n l√† AI chuy√™n ph√¢n t√≠ch √Ω ƒë·ªãnh mua h√†ng. Ch·ªâ tr·∫£ v·ªÅ JSON ch√≠nh x√°c."},
                    {"role": "user", "content": prompt}
                ],
                max_tokens=200,
                temperature=0.1
            )
            
            result_text = response.choices[0].message.content.strip()
            
            # Parse JSON
            json_match = re.search(r'\{.*\}', result_text, re.DOTALL)
            if json_match:
                result = json.loads(json_match.group(0))
                return result
            
            return {'is_purchase': False}
            
        except Exception as e:
            print(f"[ERROR] OpenAI purchase detection: {e}")
            return {'is_purchase': False}

    def _detect_purchase_gemini(self, query: str) -> Dict:
        """Ph√°t hi·ªán √Ω ƒë·ªãnh mua h√†ng b·∫±ng Gemini"""
        # Implementation t∆∞∆°ng t·ª± nh∆∞ code c≈©
        return {'is_purchase': False}

    def _detect_purchase_simple(self, query: str) -> Dict:
        """Ph√°t hi·ªán √Ω ƒë·ªãnh mua h√†ng ƒë∆°n gi·∫£n"""
        query_lower = query.lower()
        purchase_keywords = ['mua', 'ƒë·∫∑t', 'order', 'th√™m v√†o gi·ªè', 'cho v√†o gi·ªè', 'l·∫•y', 'g√≥i']
        
        has_purchase_intent = any(keyword in query_lower for keyword in purchase_keywords)
        
        return {
            'is_purchase': has_purchase_intent,
            'products': [],
            'confidence': 0.7 if has_purchase_intent else 0.1
        }

    def get_model_info(self) -> Dict:
        """Th√¥ng tin v·ªÅ model ƒëang s·ª≠ d·ª•ng"""
        return {
            "model_type": self.model_type,
            "model_name": "gpt-4o-mini" if self.model_type == "openai" else "gemini-2.0-flash" if self.model_type == "gemini" else "simple",
            "capabilities": {
                "natural_conversation": self.model_type in ["openai", "gemini"],
                "context_awareness": self.model_type in ["openai", "gemini"], 
                "purchase_detection": True,
                "emotional_intelligence": self.model_type == "openai"
            }
        }
