@model Exe_Demo.Models.ViewModels.ProductManagementViewModel
@{
    ViewData["Title"] = "Quản lý sản phẩm";
    Layout = "~/Views/Shared/_StaffLayout.cshtml";
}

<div class="container-fluid py-5">
    <!-- Page Header -->
    <div class="page-title mb-5">
        <div class="container">
            <div class="row align-items-center justify-content-between">
                <div class="col-auto">
                    <h2 style="margin: 0; color: white;">
                        <i class="fa fa-cube" style="margin-right: 12px;"></i>Quản Lý Sản Phẩm
                    </h2>
                </div>
                <div class="col-auto">
                    <a asp-action="CreateProduct" class="btn btn-light btn-sm" style="margin-right: 8px;">
                        <i class="fa fa-plus"></i> Thêm Sản Phẩm
                    </a>
                    <a asp-action="Dashboard" class="btn btn-light btn-sm">
                        <i class="fa fa-arrow-left"></i> Quay lại
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Bộ lọc -->
        <div class="card border-0 mb-5">
            <div class="card-header">
                <h5 style="margin-bottom: 0;">
                    <i class="fa fa-sliders" style="margin-right: 10px;"></i>Bộ Lọc & Tìm Kiếm
                </h5>
            </div>
            <div class="card-body">
                <form method="get" asp-action="Products">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label" style="font-weight: 600; color: #333;">Tìm kiếm</label>
                            <input type="text" name="search" class="form-control" placeholder="Tìm sản phẩm..." 
                                   value="@Model.SearchTerm">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-weight: 600; color: #333;">Danh mục</label>
                            <select name="category" class="form-select">
                                <option value="">Tất cả danh mục</option>
                                @foreach (var cat in Model.Categories)
                                {
                                    <option value="@cat.CategoryId" selected="@(Model.CategoryFilter == cat.CategoryId)">
                                        @cat.CategoryName
                                    </option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" style="font-weight: 600; color: #333;">Tồn kho</label>
                            <select name="stock" class="form-select">
                                <option value="">Tất cả tồn kho</option>
                                <option value="low" selected="@(Model.StockFilter == "low")">Sắp hết hàng</option>
                                <option value="out" selected="@(Model.StockFilter == "out")">Hết hàng</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fa fa-search"></i> <span class="d-none d-sm-inline">Tìm kiếm</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Danh sách sản phẩm -->
        <div class="card border-0">
            <div class="card-header">
                <h5 style="margin-bottom: 0;">
                    <i class="fa fa-list" style="margin-right: 10px;"></i>Danh Sách Sản Phẩm
                </h5>
            </div>
            <div class="card-body p-0">
                @if (Model.Products?.Count > 0)
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 80px; font-weight: 700;"><i class="fa fa-image"></i> Ảnh</th>
                                    <th style="font-weight: 700;"><i class="fa fa-barcode"></i> Mã</th>
                                    <th style="font-weight: 700;"><i class="fa fa-tag"></i> Tên Sản Phẩm</th>
                                    <th style="font-weight: 700;"><i class="fa fa-folder"></i> Danh Mục</th>
                                    <th style="font-weight: 700;"><i class="fa fa-balance-scale"></i> Trọng lượng</th>
                                    <th style="font-weight: 700;"><i class="fa fa-money"></i> Giá</th>
                                    <th style="font-weight: 700;"><i class="fa fa-cubes"></i> Tồn Kho</th>
                                    <th style="font-weight: 700;"><i class="fa fa-bar-chart"></i> Đã Bán</th>
                                    <th style="font-weight: 700;"><i class="fa fa-toggle-on"></i> Trạng Thái</th>
                                    <th style="width: 120px; font-weight: 700; text-align: center;"><i class="fa fa-cog"></i></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var product in Model.Products)
                                {
                                    <tr>
                                        <td>
                                            <img src="@(product.ImageUrl ?? "/images/product_1.jpg")" alt="@product.ProductName" 
                                                 class="rounded" style="width: 60px; height: 60px; object-fit: cover; border: 1px solid #e0e0e0;">
                                        </td>
                                        <td style="font-weight: 700; color: #2d5016;">@product.ProductCode</td>
                                        <td>
                                            <div style="font-weight: 600;">@product.ProductName</div>
                                            @if (product.DiscountPercent > 0)
                                            {
                                                <small style="color: #e74c3c; font-weight: 600;">
                                                    <i class="fa fa-tag"></i> Giảm @product.DiscountPercent%
                                                </small>
                                            }
                                        </td>
                                        <td>@product.Category?.CategoryName</td>
                                        <td>@product.Weight</td>
                                        <td style="font-weight: 700; color: #27ae60;">
                                            @product.Price.ToString("N0") đ
                                            @if (product.OriginalPrice.HasValue && product.OriginalPrice > product.Price)
                                            {
                                                <br><small class="text-muted"><del>@product.OriginalPrice.Value.ToString("N0") đ</del></small>
                                            }
                                        </td>
                                        <td>
                                            @if (product.StockQuantity <= 0)
                                            {
                                                <span class="badge bg-danger" style="font-size: 12px; padding: 6px 10px;">
                                                    <i class="fa fa-times"></i> Hết
                                                </span>
                                            }
                                            else if (product.StockQuantity <= product.MinStockLevel)
                                            {
                                                <span class="badge bg-warning" style="font-size: 12px; padding: 6px 10px;">
                                                    <i class="fa fa-exclamation"></i> @product.StockQuantity
                                                </span>
                                            }
                                            else
                                            {
                                                <strong style="color: #27ae60;">@product.StockQuantity</strong>
                                            }
                                        </td>
                                        <td>
                                            <strong style="color: #3498db;">@(product.SoldCount ?? 0)</strong>
                                        </td>
                                        <td>
                                            @if (product.IsActive == true)
                                            {
                                                <span class="badge bg-success"><i class="fa fa-check"></i> Bán</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary"><i class="fa fa-times"></i> Ẩn</span>
                                            }
                                        </td>
                                        <td style="text-align: center;">
                                            <a asp-action="EditProduct" asp-route-id="@product.ProductId" 
                                               class="btn btn-primary btn-sm" title="Chỉnh sửa" style="padding: 6px 10px;">
                                                <i class="fa fa-edit"></i>
                                            </a>
                                            <button onclick="deleteProduct(@product.ProductId)" 
                                                    class="btn btn-danger btn-sm" title="Xóa" style="padding: 6px 10px;">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div style="padding: 3rem; text-align: center; color: #999;">
                        <i class="fa fa-inbox fa-3x mb-3" style="opacity: 0.3;"></i>
                        <p style="font-size: 16px;">Không tìm thấy sản phẩm nào</p>
                    </div>
                }
            </div>


        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div class="card-footer bg-light">
                <nav>
                    <ul class="pagination justify-content-center mb-0" style="gap: 4px;">
                        @if (Model.CurrentPage > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" asp-action="Products" 
                                   asp-route-page="@(Model.CurrentPage - 1)"
                                   asp-route-search="@Model.SearchTerm"
                                   asp-route-category="@Model.CategoryFilter"
                                   asp-route-stock="@Model.StockFilter">
                                    <i class="fa fa-chevron-left"></i> Trước
                                </a>
                            </li>
                        }

                        @for (int i = 1; i <= Model.TotalPages; i++)
                        {
                            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                <a class="page-link" asp-action="Products" 
                                   asp-route-page="@i"
                                   asp-route-search="@Model.SearchTerm"
                                   asp-route-category="@Model.CategoryFilter"
                                   asp-route-stock="@Model.StockFilter">@i</a>
                            </li>
                        }

                        @if (Model.CurrentPage < Model.TotalPages)
                        {
                            <li class="page-item">
                                <a class="page-link" asp-action="Products" 
                                   asp-route-page="@(Model.CurrentPage + 1)"
                                   asp-route-search="@Model.SearchTerm"
                                   asp-route-category="@Model.CategoryFilter"
                                   asp-route-stock="@Model.StockFilter">
                                    Sau <i class="fa fa-chevron-right"></i>
                                </a>
                            </li>
                        }
                    </ul>
                </nav>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        function deleteProduct(id) {
            if (confirm('Bạn chắc chắn muốn xóa sản phẩm này?')) {
                fetch('/Staff/DeleteProductApi/' + id, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload(); 
                    } else {
                        alert('Lỗi: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Đã xảy ra lỗi khi xóa sản phẩm');
                });
            }
        }
    </script>
}
