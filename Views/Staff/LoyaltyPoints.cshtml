@model IEnumerable<Exe_Demo.Models.Customer>
@{
    ViewData["Title"] = "Qu\u1ea3n Lý \u0110i\u1ec3m Tích Lũy";
    Layout = "~/Views/Shared/_StaffLayout.cshtml";
}

<div class="container-fluid py-5">
    <!-- Page Header -->
    <div class="page-title mb-5">
        <div class="container">
            <div class="row align-items-center justify-content-between">
                <div class="col-auto">
                    <h2 style="margin: 0; color: white;">
                        <i class="fa fa-star" style="margin-right: 12px;"></i>Qu\u1ea3n Lý \u0110i\u1ec3m Tích Lũy
                    </h2>
                </div>
                <div class="col-auto">
                    <a asp-action="Dashboard" class="btn btn-light btn-sm">
                        <i class="fa fa-arrow-left"></i> Quay l\u1ea1i
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Search & Filter -->
        <div class="card border-0 mb-4">
            <div class="card-header">
                <h5 style="margin-bottom: 0;">
                    <i class="fa fa-search" style="margin-right: 10px;"></i>Tìm Kiếm Khách Hàng
                </h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-10">
                        <input type="text" name="search" class="form-control" 
                               placeholder="Tìm theo tên, số điện thoại, email..." 
                               value="@ViewBag.SearchTerm">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fa fa-search"></i> Tìm kiếm
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="card-body">
                        <h3 style="color: white; margin-bottom: 0;">@Model.Count()</h3>
                        <p class="mb-0">Tổng khách hàng</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-0" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    <div class="card-body">
                        <h3 style="color: white; margin-bottom: 0;">@Model.Sum(c => c.LoyaltyPoints ?? 0).ToString("N0")</h3>
                        <p class="mb-0">Tổng điểm</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-0" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                    <div class="card-body">
                        <h3 style="color: white; margin-bottom: 0;">@Model.Count(c => (c.LoyaltyPoints ?? 0) > 0)</h3>
                        <p class="mb-0">Có điểm</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-0" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                    <div class="card-body">
                        <h3 style="color: white; margin-bottom: 0;">@(Model.Any() ? Model.Average(c => c.LoyaltyPoints ?? 0).ToString("N0") : "0")</h3>
                        <p class="mb-0">Trung bình điểm</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer List -->
        <div class="card border-0">
            <div class="card-header">
                <h5 style="margin-bottom: 0;">
                    <i class="fa fa-users" style="margin-right: 10px;"></i>Danh Sách Khách Hàng
                </h5>
            </div>
            <div class="card-body p-0">
                @if (Model.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead>
                                <tr>
                                    <th style="font-weight: 700;"><i class="fa fa-hashtag"></i> STT</th>
                                    <th style="font-weight: 700;"><i class="fa fa-user"></i> Họ Tên</th>
                                    <th style="font-weight: 700;"><i class="fa fa-phone"></i> SĐT</th>
                                    <th style="font-weight: 700;"><i class="fa fa-envelope"></i> Email</th>
                                    <th style="font-weight: 700; text-align: center;"><i class="fa fa-star"></i> Điểm</th>
                                    <th style="font-weight: 700; text-align: center;"><i class="fa fa-cog"></i> Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{
                                    int stt = (ViewBag.CurrentPage - 1) * 20 + 1;
                                }
                                @foreach (var customer in Model)
                                {
                                    <tr>
                                        <td style="font-weight: 600;">@stt</td>
                                        <td>
                                            <div style="font-weight: 600;">@customer.FullName</div>
                                        </td>
                                        <td>@customer.PhoneNumber</td>
                                        <td>@customer.Email</td>
                                        <td style="text-align: center;">
                                            <span class="badge bg-primary" style="font-size: 14px; padding: 8px 16px;">
                                                <i class="fa fa-star"></i> @(customer.LoyaltyPoints ?? 0) điểm
                                            </span>
                                        </td>
                                        <td style="text-align: center;">
                                            <button class="btn btn-sm btn-warning" 
                                                    onclick="showAdjustModal(@customer.CustomerId, '@customer.FullName', @(customer.LoyaltyPoints ?? 0))" 
                                                    title="Điều chỉnh điểm">
                                                <i class="fa fa-edit"></i> Điều chỉnh
                                            </button>
                                            <a asp-action="LoyaltyPointsHistory" asp-route-customerId="@customer.CustomerId" 
                                               class="btn btn-sm btn-info" title="Lịch sử">
                                                <i class="fa fa-history"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    stt++;
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div style="padding: 3rem; text-align: center; color: #999;">
                        <i class="fa fa-inbox fa-3x mb-3" style="opacity: 0.3;"></i>
                        <p style="font-size: 16px;">Không tìm thấy khách hàng nào</p>
                    </div>
                }
            </div>

            <!-- Pagination -->
            @if (ViewBag.TotalPages > 1)
            {
                <div class="card-footer bg-light">
                    <nav>
                        <ul class="pagination justify-content-center mb-0" style="gap: 4px;">
                            @if (ViewBag.CurrentPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" asp-action="LoyaltyPoints" 
                                       asp-route-page="@(ViewBag.CurrentPage - 1)"
                                       asp-route-search="@ViewBag.SearchTerm">
                                        <i class="fa fa-chevron-left"></i> Trước
                                    </a>
                                </li>
                            }

                            @for (int i = 1; i <= ViewBag.TotalPages; i++)
                            {
                                <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                    <a class="page-link" asp-action="LoyaltyPoints" 
                                       asp-route-page="@i"
                                       asp-route-search="@ViewBag.SearchTerm">@i</a>
                                </li>
                            }

                            @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                            {
                                <li class="page-item">
                                    <a class="page-link" asp-action="LoyaltyPoints" 
                                       asp-route-page="@(ViewBag.CurrentPage + 1)"
                                       asp-route-search="@ViewBag.SearchTerm">
                                        Sau <i class="fa fa-chevron-right"></i>
                                    </a>
                                </li>
                            }
                        </ul>
                    </nav>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal Điều chỉnh điểm -->
<div class="modal fade" id="adjustModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fa fa-edit"></i> Điều Chỉnh Điểm Tích Lũy</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="adjustCustomerId">
                <div class="form-group">
                    <label class="form-label" style="font-weight: 600;">Khách hàng:</label>
                    <input type="text" id="adjustCustomerName" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" style="font-weight: 600;">Điểm hiện tại:</label>
                    <input type="text" id="adjustCurrentPoints" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" style="font-weight: 600;">Điểm thay đổi: <small class="text-muted">(Số âm để trừ điểm)</small></label>
                    <input type="number" id="adjustPoints" class="form-control" placeholder="VD: 10 (cộng) hoặc -10 (trừ)" required>
                </div>
                <div class="form-group">
                    <label class="form-label" style="font-weight: 600;">Lý do:</label>
                    <textarea id="adjustReason" class="form-control" rows="3" placeholder="Nhập lý do điều chỉnh..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="submitAdjust()">
                    <i class="fa fa-check"></i> Xác nhận
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function showAdjustModal(customerId, customerName, currentPoints) {
            $('#adjustCustomerId').val(customerId);
            $('#adjustCustomerName').val(customerName);
            $('#adjustCurrentPoints').val(currentPoints + ' điểm');
            $('#adjustPoints').val('');
            $('#adjustReason').val('');
            $('#adjustModal').modal('show');
        }

        function submitAdjust() {
            var customerId = $('#adjustCustomerId').val();
            var points = parseInt($('#adjustPoints').val());
            var reason = $('#adjustReason').val();

            if (!points || points === 0) {
                alert('Vui lòng nhập điểm thay đổi!');
                return;
            }

            if (!reason.trim()) {
                alert('Vui lòng nhập lý do điều chỉnh!');
                return;
            }

            $.ajax({
                url: '@Url.Action("AdjustLoyaltyPoints", "Staff")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    customerId: parseInt(customerId),
                    points: points,
                    reason: reason
                }),
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        location.reload();
                    } else {
                        alert('Lỗi: ' + response.message);
                    }
                },
                error: function() {
                    alert('Có lỗi xảy ra. Vui lòng thử lại!');
                }
            });
        }
    </script>
}
