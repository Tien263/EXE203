@model Exe_Demo.Models.ViewModels.DirectSaleViewModel
@{
    ViewData["Title"] = "Bán hàng trực tiếp";
    Layout = "~/Views/Shared/_StaffLayout.cshtml";
}

<div class="container-fluid py-5">
    <!-- Page Header -->
    <div class="page-title mb-5">
        <div class="container">
            <div class="row align-items-center justify-content-between">
                <div class="col-auto">
                    <h2 style="margin: 0; color: white;">
                        <i class="fa fa-cash-register" style="margin-right: 12px;"></i>Bán Hàng Trực Tiếp
                    </h2>
                </div>
                <div class="col-auto">
                    <a asp-action="Dashboard" class="btn btn-light btn-sm">
                        <i class="fa fa-arrow-left"></i> Quay lại
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Danh sách sản phẩm -->
            <div class="col-lg-7 mb-4">
                <div class="card border-0">
                    <div class="card-header">
                        <h5 style="margin-bottom: 0;">
                            <i class="fa fa-cubes" style="margin-right: 10px;"></i>Chọn Sản Phẩm
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Tìm kiếm -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <input type="text" id="searchProduct" class="form-control" 
                                       placeholder="Tìm sản phẩm..." value="@Model.SearchTerm"
                                       style="padding: 10px 14px; border-radius: 8px;">
                            </div>
                            <div class="col-md-4">
                                <select id="categoryFilter" class="form-select" style="padding: 10px 14px; border-radius: 8px;">
                                    <option value="">Tất cả danh mục</option>
                                    @foreach (var cat in Model.Categories)
                                    {
                                        <option value="@cat.CategoryId" selected="@(Model.CategoryFilter == cat.CategoryId)">
                                            @cat.CategoryName
                                        </option>
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Danh sách sản phẩm -->
                        <div id="productList" style="max-height: 650px; overflow-y: auto;">
                            <div class="row g-3">
                                @foreach (var product in Model.Products)
                                {
                                    <div class="col-md-6">
                                        <div class="card h-100 product-card" style="cursor: pointer; border-radius: 10px; transition: all 0.3s ease;" 
                                             onclick="addToCart(@product.ProductId, '@product.ProductCode', '@product.ProductName', @product.Price, @(product.DiscountPercent ?? 0), @(product.StockQuantity ?? 0), '@(product.ImageUrl ?? "/images/product_1.jpg")')">
                                            <div class="card-body p-3">
                                                <div class="d-flex gap-3">
                                                    <img src="@(product.ImageUrl ?? "/images/product_1.jpg")" 
                                                         alt="@product.ProductName" class="rounded" 
                                                         style="width: 70px; height: 70px; object-fit: cover; border: 1px solid #e0e0e0;">
                                                    <div class="flex-grow-1 d-flex flex-column justify-content-between">
                                                        <div>
                                                            <h6 style="margin: 0; font-weight: 700; color: #2d5016;">@product.ProductName</h6>
                                                            @if (product.DiscountPercent > 0)
                                                            {
                                                                <small style="color: #e74c3c; font-weight: 600;">
                                                                    <i class="fa fa-tag"></i> Giảm @product.DiscountPercent%
                                                                </small>
                                                            }
                                                        </div>
                                                        <div>
                                                            <div style="font-weight: 700; color: #27ae60; font-size: 15px;">@product.Price.ToString("N0") đ</div>
                                                            @if (product.StockQuantity <= 0)
                                                            {
                                                                <span class="badge bg-danger" style="font-size: 11px;">Hết hàng</span>
                                                            }
                                                            else if (product.StockQuantity <= 5)
                                                            {
                                                                <span class="badge bg-warning" style="font-size: 11px;">Tồn: @product.StockQuantity</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-success" style="font-size: 11px;">Có sẵn</span>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Giỏ hàng & Thanh toán -->
            <div class="col-lg-5">
                <!-- Thông tin khách hàng -->
                <div class="card border-0 mb-4">
                    <div class="card-header">
                        <h5 style="margin-bottom: 0;">
                            <i class="fa fa-user" style="margin-right: 10px;"></i>Thông Tin Khách Hàng
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 600; color: #333;">Số Điện Thoại</label>
                            <div class="input-group">
                                <input type="text" id="customerPhone" class="form-control" 
                                       placeholder="Nhập số điện thoại" style="padding: 10px 14px;">
                                <button class="btn btn-primary" type="button" onclick="searchCustomer()" title="Tìm khách hàng">
                                    <i class="fa fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 600; color: #333;">Tên Khách Hàng *</label>
                            <input type="text" id="customerName" class="form-control" 
                                   placeholder="Tên khách hàng" required style="padding: 10px 14px;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 600; color: #333;">Email</label>
                            <input type="email" id="customerEmail" class="form-control" 
                                   placeholder="Email (tùy chọn)" style="padding: 10px 14px;">
                        </div>
                        <input type="hidden" id="customerId" value="">
                    </div>
                </div>

                <!-- Giỏ hàng -->
                <div class="card border-0">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 style="margin: 0;">
                            <i class="fa fa-shopping-cart" style="margin-right: 10px;"></i>Giỏ Hàng
                        </h5>
                        <button class="btn btn-sm btn-outline-danger" onclick="clearCart()" title="Xóa tất cả">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div id="cartItems" style="max-height: 350px; overflow-y: auto;">
                            <div class="text-center py-5 text-muted">
                                <i class="fa fa-inbox fa-3x mb-3" style="opacity: 0.3;"></i>
                                <p>Giỏ hàng trống</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-light" style="border-top: 1px solid #e0e0e0;">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span style="color: #666;">Tạm tính:</span>
                                <strong id="subtotal">0 đ</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span style="color: #666;">Giảm giá:</span>
                                <input type="number" id="discountAmount" class="form-control form-control-sm" 
                                       value="0" min="0" onchange="updateTotal()" style="width: 120px; padding: 6px 10px;">
                            </div>
                            <hr style="margin: 12px 0;">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong style="font-size: 16px;">Tổng cộng:</strong>
                                <h4 style="margin: 0; color: #27ae60;" id="finalAmount">0 đ</h4>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 600; color: #333;">Phương Thức Thanh Toán</label>
                            <select id="paymentMethod" class="form-select" style="padding: 10px 14px;">
                                <option value="Tiền mặt"><i class="fa fa-money"></i> Tiền mặt</option>
                                <option value="Chuyển khoản">Chuyển khoản</option>
                                <option value="Thẻ">Thẻ tín dụng</option>
                            </select>
                        </div>
                        <button class="btn btn-primary w-100" onclick="createOrder()" style="padding: 12px; font-size: 16px; font-weight: 700;">
                            <i class="fa fa-check"></i> Hoàn Tất Thanh Toán
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let cart = [];

        function addToCart(productId, productCode, productName, price, discountPercent, stockQuantity, imageUrl) {
            if (stockQuantity <= 0) {
                alert('Sản phẩm này đã hết hàng!');
                return;
            }

            const existingItem = cart.find(item => item.productId === productId);
            
            if (existingItem) {
                if (existingItem.quantity >= stockQuantity) {
                    alert('Không đủ hàng trong kho!');
                    return;
                }
                existingItem.quantity++;
            } else {
                cart.push({
                    productId: productId,
                    productCode: productCode,
                    productName: productName,
                    price: price,
                    quantity: 1,
                    discountPercent: discountPercent,
                    stockQuantity: stockQuantity,
                    imageUrl: imageUrl
                });
            }
            
            renderCart();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.productId !== productId);
            renderCart();
        }

        function updateQuantity(productId, quantity) {
            const item = cart.find(item => item.productId === productId);
            if (item) {
                if (quantity > item.stockQuantity) {
                    alert('Không đủ hàng trong kho!');
                    return;
                }
                if (quantity <= 0) {
                    removeFromCart(productId);
                } else {
                    item.quantity = quantity;
                    renderCart();
                }
            }
        }

        function clearCart() {
            if (confirm('Bạn có chắc muốn xóa tất cả sản phẩm?')) {
                cart = [];
                renderCart();
            }
        }

        function renderCart() {
            const cartContainer = document.getElementById('cartItems');
            
            if (cart.length === 0) {
                cartContainer.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="fa fa-inbox fa-3x mb-3" style="opacity: 0.3;"></i>
                        <p>Giỏ hàng trống</p>
                    </div>
                `;
            } else {
                let html = '<div style="padding: 12px;">';
                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity * (100 - item.discountPercent) / 100;
                    html += `
                        <div style="display: flex; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #e0e0e0;">
                            <img src="${item.imageUrl}" alt="${item.productName}" 
                                 class="rounded" style="width: 50px; height: 50px; object-fit: cover; margin-right: 12px; border: 1px solid #e0e0e0;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d5016;">${item.productName}</div>
                                <small style="color: #999;">${item.price.toLocaleString()} đ</small>
                                ${item.discountPercent > 0 ? `<span class="badge bg-danger ms-1" style="font-size: 11px;">-${item.discountPercent}%</span>` : ''}
                            </div>
                            <div style="text-align: right; min-width: 120px;">
                                <div class="input-group input-group-sm mb-2" style="width: 95px;">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" style="padding: 4px 8px;" 
                                            onclick="updateQuantity(${item.productId}, ${item.quantity - 1})">-</button>
                                    <input type="number" class="form-control form-control-sm text-center" value="${item.quantity}" 
                                           onchange="updateQuantity(${item.productId}, parseInt(this.value))" min="1" style="padding: 4px 2px;">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" style="padding: 4px 8px;" 
                                            onclick="updateQuantity(${item.productId}, ${item.quantity + 1})">+</button>
                                </div>
                                <div style="font-weight: 700; color: #e74c3c; font-size: 13px; margin-bottom: 4px;">${itemTotal.toLocaleString()} đ</div>
                                <button class="btn btn-sm p-0" style="color: #e74c3c;" 
                                        onclick="removeFromCart(${item.productId})" title="Xóa">
                                    <i class="fa fa-trash" style="font-size: 12px;"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                cartContainer.innerHTML = html;
            }
            
            updateTotal();
        }

        function updateTotal() {
            let subtotal = 0;
            cart.forEach(item => {
                subtotal += item.price * item.quantity * (100 - item.discountPercent) / 100;
            });
            
            const discountAmount = parseFloat(document.getElementById('discountAmount').value) || 0;
            const finalAmount = subtotal - discountAmount;
            
            document.getElementById('subtotal').textContent = subtotal.toLocaleString() + ' đ';
            document.getElementById('finalAmount').textContent = finalAmount.toLocaleString() + ' đ';
        }

        function searchCustomer() {
            const phone = document.getElementById('customerPhone').value;
            if (!phone) {
                alert('Vui lòng nhập số điện thoại');
                return;
            }

            fetch('/Staff/SearchCustomer?phone=' + phone)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('customerId').value = data.customer.customerId;
                        document.getElementById('customerName').value = data.customer.fullName;
                        document.getElementById('customerEmail').value = data.customer.email || '';
                        alert('Đã tìm thấy khách hàng!');
                    } else {
                        document.getElementById('customerId').value = '';
                        alert('Không tìm thấy khách hàng. Vui lòng nhập thông tin mới.');
                    }
                })
                .catch(error => {
                    alert('Có lỗi xảy ra: ' + error);
                });
        }

        function createOrder() {
            if (cart.length === 0) {
                alert('Giỏ hàng trống!');
                return;
            }

            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            
            if (!customerName || !customerPhone) {
                alert('Vui lòng nhập thông tin khách hàng!');
                return;
            }

            const orderData = {
                customerName: customerName,
                customerPhone: customerPhone,
                customerEmail: document.getElementById('customerEmail').value,
                customerId: document.getElementById('customerId').value || null,
                paymentMethod: document.getElementById('paymentMethod').value,
                discountAmount: parseFloat(document.getElementById('discountAmount').value) || 0,
                items: cart.map(item => ({
                    productId: item.productId,
                    quantity: item.quantity,
                    price: item.price,
                    discountPercent: item.discountPercent
                }))
            };

            fetch('/Staff/CreateDirectSaleOrder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Tạo đơn hàng thành công! Mã đơn: ' + data.orderCode);
                    cart = [];
                    renderCart();
                    document.getElementById('customerName').value = '';
                    document.getElementById('customerPhone').value = '';
                    document.getElementById('customerEmail').value = '';
                    document.getElementById('customerId').value = '';
                    document.getElementById('discountAmount').value = 0;
                } else {
                    alert(data.message);
                }
            })
            .catch(error => {
                alert('Có lỗi xảy ra: ' + error);
            });
        }

        // Search and filter
        document.getElementById('searchProduct').addEventListener('input', function(e) {
            const search = e.target.value;
            const category = document.getElementById('categoryFilter').value;
            window.location.href = '/Staff/DirectSale?search=' + search + '&category=' + category;
        });

        document.getElementById('categoryFilter').addEventListener('change', function(e) {
            const search = document.getElementById('searchProduct').value;
            const category = e.target.value;
            window.location.href = '/Staff/DirectSale?search=' + search + '&category=' + category;
        });
    </script>
}

<style>
    .product-card {
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
    }

    .product-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        transform: translateY(-4px);
        border-color: #82b440;
    }
</style>
